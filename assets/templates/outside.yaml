## TEMPLATES / OUTSIDE

# -- binary sensors --
- binary_sensor:
  # -- acurite (rtl) --
  # temperature sensor battery state
  - name: 'SNR Outside Temperature Battery Low'
    state: >
      {# battery_ok: 1=normal, 0=low #}
      {% if is_number(state_attr('sensor.snr_outside_temperature', 'battery_ok')) %}
        {{ is_state_attr('sensor.snr_outside_temperature', 'battery_ok', 0) }}
      {% endif %}

  # -- toyota tpms & climate (rtl) --
  # truck location (home or away)
  - name: 'SNR Tacoma Location'
    device_class: presence
    state: >
      {# sensor has updated in the last 15 minutes #}
      {% set time_offset = 900 %}
      {{ 
        (utcnow() - states.sensor.snr_outside_tacomaclimate_temperature.last_updated).total_seconds() < time_offset or
        (utcnow() - states.sensor.snr_outside_tacoma_tpms1.last_updated).total_seconds() < time_offset or
        (utcnow() - states.sensor.snr_outside_tacoma_tpms2.last_updated).total_seconds() < time_offset or
        (utcnow() - states.sensor.snr_outside_tacoma_tpms3.last_updated).total_seconds() < time_offset or
        (utcnow() - states.sensor.snr_outside_tacoma_tpms3.last_updated).total_seconds() < time_offset
      }}


# --- sensors ---
- sensor:
    # -- purple air --
    # aqi description
    - name: 'PurpleAir AQI Description'
      state: >
        {% if is_number(states('sensor.purpleair')) %}
          {% if (states('sensor.purpleair') | float) >= 401.0 %}
            Hazardous
          {% elif (states('sensor.purpleair') | float) >= 301.0 %}
            Hazardous
          {% elif (states('sensor.purpleair') | float) >= 201.0 %}
            Very Unhealthy
          {% elif (states('sensor.purpleair') | float) >= 151.0 %}
            Unhealthy
          {% elif (states('sensor.purpleair') | float) >= 101.0 %}
            Unhealthy for Sensitive Groups
          {% elif (states('sensor.purpleair') | float) >= 51.0 %}
            Moderate
          {% elif (states('sensor.purpleair') | float) >= 0.0 %}
            Good
          {% else %}
            Unknown
          {% endif %}
        {% else %}
          Unknown
        {% endif %}

    # fine particulate matter 2.5
    - name: 'PurpleAir PM 2.5'
      device_class: pm25
      unit_of_measurement: "μg/m³"
      state: >
        {{ state_attr('sensor.purpleair','results')[0]['PM2_5Value'] | round(1, default=1.0) }}

    # fine particulate matter 10
    - name: 'PurpleAir PM 10'
      device_class: pm10
      unit_of_measurement: "μg/m³"
      state: >
        {{ state_attr('sensor.purpleair','results')[0]['pm10_0_atm'] | round(1, default=1.0) }}